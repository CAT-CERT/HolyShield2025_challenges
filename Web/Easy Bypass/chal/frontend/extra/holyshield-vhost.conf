Define BACKEND_HOST backend:8088
Define BACKEND_HOSTPORT backend:8088
Define ALTERNATE backend:8088

Listen 8888
<VirtualHost *:8888>
    ServerName localhost
    CustomLog /dev/null common

    DocumentRoot /usr/local/apache2/htdocs

    ServerAlias www.localhost localhost.localdomain
    ServerAdmin admin@example.com
    UseCanonicalName Off

    ServerSignature Off
    TraceEnable Off

    <IfModule mod_reqtimeout.c>
        RequestReadTimeout header=10-20,MinRate=500 body=20,MinRate=500
    </IfModule>

    <IfModule mod_proxy.c>
        ProxyPreserveHost On
        ProxyRequests Off
        ProxyTimeout 60

        Proxy100Continue Off

        <IfModule mod_proxy_balancer.c>
            <Proxy "balancer://backend_pool">
                BalancerMember "http://${BACKEND_HOSTPORT}"
                BalancerMember "http://${ALTERNATE}" status=+H
            </Proxy>
        </IfModule>

        <IfModule mod_proxy_http.c>

            ProxyPassInterpolateEnv Off

            ProxyPassMatch "^/static/(.*\.(?:css|js|png|jpg|svg))$" "http://localhost/static/$1" retry=0

            ProxyPass "/internal" "!"

            ProxyPass        "/" "http://${BACKEND_HOSTPORT}/"
            ProxyPassReverse "/" "http://${BACKEND_HOSTPORT}/"
        </IfModule>
    </IfModule>

    <IfModule mod_headers.c>
        RequestHeader add X-Access-Denied "banned" early

        Header always set Connection "close" \
            "expr=req('Connection') !~ m#(?:^|,)\\s*(?:close|keep-alive)\\s*(?:,|$)#i"

        RequestHeader unset Proxy early
        RequestHeader unset Proxy-Authorization early
        RequestHeader unset Proxy-Connection early

        Header always set X-Content-Type-Options "nosniff"
        Header always set Referrer-Policy "no-referrer"
        Header always set Permissions-Policy "geolocation=(), microphone=(), camera=()"
    </IfModule>

    SetEnvIf Request_URI "^/login$" IS_LOGIN=1
    SetEnvIf Request_URI "^/admin" IS_ADMIN_PATH=1
    SetEnvIf Remote_Addr "127\.0\.0\.1" LOCAL_REQUEST=1

    SetEnvIfNoCase Cookie "auth=redacted" IS_ADMIN_USER=1

    <Location "/login">
        <IfModule mod_headers.c>
            RequestHeader unset X-Access-Denied env=IS_LOGIN
        </IfModule>
        Header set X-Login-Observed "%{REMOTE_ADDR}e" env=IS_LOGIN
    </Location>

    <LocationMatch "(?i)^/admin(?:/|$)">
        <IfModule mod_headers.c>
            RequestHeader unset X-Access-Denied env=IS_ADMIN_USER
        </IfModule>

        Require env IS_ADMIN_USER
    </LocationMatch>

    <IfModule mod_xsendfile.c>
        XSendFile On
        XSendFilePath /
    </IfModule>

    RewriteEngine on
    RewriteRule "^/proxy/(.*)" "http://backend:8088/?body=$1" [P]
    ProxyPassReverse "/proxy/" "http://backend:8088/"

    MaxKeepAliveRequests 100
    Timeout 60

    Header always set X-Server-Tag "holyshield-v1" env=!IS_ADMIN_USER
    Header unset X-Access-Denied env=IS_LOGIN
</VirtualHost>
